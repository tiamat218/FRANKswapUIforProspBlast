{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nconst tslib_1 = require(\"tslib\");\nconst utils_1 = require(\"@walletconnect/utils\");\nconst network_1 = tslib_1.__importDefault(require(\"./network\"));\nconst WS = typeof global.WebSocket !== \"undefined\" ? global.WebSocket : require(\"ws\");\nclass SocketTransport {\n  constructor(opts) {\n    this._queue = [];\n    this._events = [];\n    this._subscriptions = [];\n    this._protocol = opts.protocol;\n    this._version = opts.version;\n    this._url = \"\";\n    this._netMonitor = null;\n    this._socket = null;\n    this._nextSocket = null;\n    this._subscriptions = opts.subscriptions || [];\n    this._netMonitor = opts.netMonitor || new network_1.default();\n    if (!opts.url || typeof opts.url !== \"string\") {\n      throw new Error(\"Missing or invalid WebSocket url\");\n    }\n    this._url = opts.url;\n    this._netMonitor.on(\"online\", () => this._socketCreate());\n  }\n  set readyState(value) {}\n  get readyState() {\n    return this._socket ? this._socket.readyState : -1;\n  }\n  set connecting(value) {}\n  get connecting() {\n    return this.readyState === 0;\n  }\n  set connected(value) {}\n  get connected() {\n    return this.readyState === 1;\n  }\n  set closing(value) {}\n  get closing() {\n    return this.readyState === 2;\n  }\n  set closed(value) {}\n  get closed() {\n    return this.readyState === 3;\n  }\n  open() {\n    this._socketCreate();\n  }\n  close() {\n    this._socketClose();\n  }\n  send(message, topic, silent) {\n    if (!topic || typeof topic !== \"string\") {\n      throw new Error(\"Missing or invalid topic field\");\n    }\n    this._socketSend({\n      topic: topic,\n      type: \"pub\",\n      payload: message,\n      silent: !!silent\n    });\n  }\n  subscribe(topic) {\n    this._socketSend({\n      topic: topic,\n      type: \"sub\",\n      payload: \"\",\n      silent: true\n    });\n  }\n  on(event, callback) {\n    this._events.push({\n      event,\n      callback\n    });\n  }\n  _socketCreate() {\n    if (this._nextSocket) {\n      return;\n    }\n    const url = getWebSocketUrl(this._url, this._protocol, this._version);\n    this._nextSocket = new WS(url);\n    if (!this._nextSocket) {\n      throw new Error(\"Failed to create socket\");\n    }\n    this._nextSocket.onmessage = event => this._socketReceive(event);\n    this._nextSocket.onopen = () => this._socketOpen();\n    this._nextSocket.onerror = event => this._socketError(event);\n    this._nextSocket.onclose = () => {\n      this._nextSocket = null;\n      this._socketCreate();\n    };\n  }\n  _socketOpen() {\n    this._socketClose();\n    this._socket = this._nextSocket;\n    this._nextSocket = null;\n    this._queueSubscriptions();\n    this._pushQueue();\n  }\n  _socketClose() {\n    if (this._socket) {\n      this._socket.onclose = () => {};\n      this._socket.close();\n    }\n  }\n  _socketSend(socketMessage) {\n    const message = JSON.stringify(socketMessage);\n    if (this._socket && this._socket.readyState === 1) {\n      this._socket.send(message);\n    } else {\n      this._setToQueue(socketMessage);\n      this._socketCreate();\n    }\n  }\n  _socketReceive(event) {\n    return tslib_1.__awaiter(this, void 0, void 0, function* () {\n      let socketMessage;\n      try {\n        socketMessage = JSON.parse(event.data);\n      } catch (error) {\n        return;\n      }\n      this._socketSend({\n        topic: socketMessage.topic,\n        type: \"ack\",\n        payload: \"\",\n        silent: true\n      });\n      if (this._socket && this._socket.readyState === 1) {\n        const events = this._events.filter(event => event.event === \"message\");\n        if (events && events.length) {\n          events.forEach(event => event.callback(socketMessage));\n        }\n      }\n    });\n  }\n  _socketError(e) {\n    const events = this._events.filter(event => event.event === \"error\");\n    if (events && events.length) {\n      events.forEach(event => event.callback(e));\n    }\n  }\n  _queueSubscriptions() {\n    const subscriptions = this._subscriptions;\n    subscriptions.forEach(topic => this._queue.push({\n      topic: topic,\n      type: \"sub\",\n      payload: \"\",\n      silent: true\n    }));\n    this._subscriptions = [];\n  }\n  _setToQueue(socketMessage) {\n    this._queue.push(socketMessage);\n  }\n  _pushQueue() {\n    const queue = this._queue;\n    queue.forEach(socketMessage => this._socketSend(socketMessage));\n    this._queue = [];\n  }\n}\nfunction getWebSocketUrl(_url, protocol, version) {\n  var _a, _b;\n  const url = _url.startsWith(\"https\") ? _url.replace(\"https\", \"wss\") : _url.startsWith(\"http\") ? _url.replace(\"http\", \"ws\") : _url;\n  const splitUrl = url.split(\"?\");\n  const params = utils_1.isBrowser() ? {\n    protocol,\n    version,\n    env: \"browser\",\n    host: ((_a = utils_1.getLocation()) === null || _a === void 0 ? void 0 : _a.host) || \"\"\n  } : {\n    protocol,\n    version,\n    env: ((_b = utils_1.detectEnv()) === null || _b === void 0 ? void 0 : _b.name) || \"\"\n  };\n  const queryString = utils_1.appendToQueryString(utils_1.getQueryString(splitUrl[1] || \"\"), params);\n  return splitUrl[0] + \"?\" + queryString;\n}\nexports.default = SocketTransport;","map":{"version":3,"names":["utils_1","require","network_1","tslib_1","__importDefault","WS","global","WebSocket","SocketTransport","constructor","opts","_queue","_events","_subscriptions","_protocol","protocol","_version","version","_url","_netMonitor","_socket","_nextSocket","subscriptions","netMonitor","default","url","Error","on","_socketCreate","readyState","value","connecting","connected","closing","closed","open","close","_socketClose","send","message","topic","silent","_socketSend","type","payload","subscribe","event","callback","push","getWebSocketUrl","onmessage","_socketReceive","onopen","_socketOpen","onerror","_socketError","onclose","_queueSubscriptions","_pushQueue","socketMessage","JSON","stringify","_setToQueue","parse","data","error","events","filter","length","forEach","e","queue","startsWith","replace","splitUrl","split","params","isBrowser","env","host","_a","getLocation","_b","detectEnv","name","queryString","appendToQueryString","getQueryString","exports"],"sources":["../../src/index.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script"}